#### from https://gitlab.cern.ch/gitlabci-examples/build_docker_image/-/blob/master/.gitlab-ci.yml?ref_type=heads
.base_build_container:
    stage: build
    variables:
      # To push to a specific docker tag other than latest(the default), amend the --destination parameter, e.g. --destination $CI_REGISTRY_IMAGE:$CI_BUILD_REF_NAME
      # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
      DOCKER_FILE: 'DOCKER_FILE'
      IMAGE_DESTINATION_LATEST: 'IMAGELATEST'
      IMAGE_DESTINATION: 'IMAGE'
    image: 
        # The kaniko debug image is recommended because it has a shell, and a shell is required for an image to be used with GitLab CI/CD.
        name: gcr.io/kaniko-project/executor:debug
        entrypoint: [""]
    script:
        # Prepare Kaniko configuration file
        - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
        # Build and push the image from the Dockerfile at the root of the project.
        - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $DOCKER_FILE --destination $IMAGE_DESTINATION --destination $IMAGE_DESTINATION_LATEST
        # Print the full registry path of the pushed image
        - echo "Image pushed successfully to ${IMAGE_DESTINATION}"
    rules:
      - if: $CI_COMMIT_BRANCH =~ /^container.*/ 
      - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^container.*/'

build_container_lpccondor:
  extends:
    - .base_build_container
  variables:
      # To push to a specific docker tag other than latest(the default), amend the --destination parameter, e.g. --destination $CI_REGISTRY_IMAGE:$CI_BUILD_REF_NAME
      # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
      DOCKER_FILE: $CI_PROJECT_DIR/.dockerfiles/Dockerfile_analysis
      IMAGE_DESTINATION_LATEST: ${CI_REGISTRY_IMAGE}:latest
      IMAGE_DESTINATION: ${CI_REGISTRY_IMAGE}:$CI_COMMIT_SHORT_SHA

# build_container_reana:
#   extends:
#     - .base_build_container
#   variables:
#       # To push to a specific docker tag other than latest(the default), amend the --destination parameter, e.g. --destination $CI_REGISTRY_IMAGE:$CI_BUILD_REF_NAME
#       # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
#       DOCKER_FILE: $CI_PROJECT_DIR/.dockerfiles/Dockerfile_analysis_reana
#       IMAGE_DESTINATION_LATEST: ${CI_REGISTRY_IMAGE}:reana_latest
#       IMAGE_DESTINATION: ${CI_REGISTRY_IMAGE}:reana_$CI_COMMIT_SHORT_SHA
