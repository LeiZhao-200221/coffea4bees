configfile: "inputs.yaml"

rule analysis_databkgs:
    output:
        "output/histdatabkgs_{sample}-{iy}.coffea"
    container:
        "docker://gitlab-registry.cern.ch/cms-cmu/coffea4bees:latest"
    params:
        hash=config['hash'],
        diff=config['diff'],
        isam="{sample}",
        iy="{iy}"
    resources:
        voms_proxy=True,
        kerberos=True,
        compute_backend="kubernetes",
        kubernetes_memory_limit="9.5Gi"
    shell:
        """
cd python/ 
echo "Running {params.isam} {params.iy} - output ../{output}"
mprof run -C -o mprofile_databkgs_{params.isam}_{params.iy}.dat python runner.py -d {params.isam} -p analysis/processors/processor_HH4b.py -y {params.iy} -o ../{output} -op ../output/ -m metadata/datasets_HH4b_cernbox.yml --githash {params.hash} --gitdiff {params.diff}  #--dask
mprof plot -o ../output/mprofile_databkgs_{params.isam}_{params.iy}.png mprofile_databkgs_{params.isam}_{params.iy}.dat
cp ../gitdiff.txt ../output/   ### only one time
#cp /tmp/coffea4bees-dask-report-* ../output/coffea4bees-dask-report_{params.isam}_{params.iy}.html
        """

